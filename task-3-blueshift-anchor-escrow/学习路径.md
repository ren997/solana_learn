# Pinocchio Vault 学习路径指南

## 📚 项目简介

**Pinocchio Vault** 是一个 Solana 智能合约项目，实现了一个资金存取库（Vault）。用户可以：
- **Deposit（存入）**：将 SOL 存入自己的 Vault PDA 账户
- **Withdraw（提取）**：从自己的 Vault PDA 账户提取所有资金

### 技术特点
- ✅ 使用 **Pinocchio 框架**（原生 Rust，非 Anchor）
- ✅ 使用 **PDA（Program Derived Address）** 存储资金
- ✅ 自动化工具链：Shank 生成 IDL，Codama 生成客户端 SDK
- ✅ 支持 TypeScript 和 Rust 客户端

---

## 🎯 学习步骤（从零开始）

### 第 1 步：环境准备 ⚙️

#### 1.1 安装 Rust 和 Solana CLI
```bash
# 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 安装 Solana CLI
sh -c "$(curl -sSfL https://release.solana.com/stable/install)"

# 验证安装
rustc --version
solana --version
```

#### 1.2 安装 Solana 构建工具
```bash
# 安装 cargo-build-sbf（用于编译 Solana 程序）
cargo install cargo-build-sbf
```

#### 1.3 安装项目依赖工具
```bash
# 安装 Shank（IDL 生成工具）
cargo install shank-cli

# 安装 Node.js 工具（用于 Codama）
# 推荐使用 bun 或 pnpm
npm install -g bun  # 或 npm install -g pnpm
```

#### 1.4 配置 Solana 本地环境
```bash
# 设置本地网络
solana config set --url localhost

# 创建测试钱包（如果还没有）
solana-keygen new

# 启动本地验证节点（新终端）
solana-test-validator
```

---

### 第 2 步：理解项目结构 📂

```
pinocchio_vault/
├── src/                    # 核心智能合约代码
│   ├── lib.rs             # 程序入口点
│   └── instructions/      # 指令实现
│       ├── mod.rs         # 模块定义和 IDL 结构
│       ├── deposit.rs     # 存款指令
│       └── withdraw.rs    # 提取指令
├── idl/                    # IDL 文件（自动生成）
├── clients/                # 客户端 SDK（自动生成）
│   ├── codegen.ts         # Codama 生成配置
│   └── src/generated/     # 生成的客户端代码
│       ├── js/            # TypeScript SDK
│       └── rust/          # Rust SDK
├── Cargo.toml             # Rust 项目配置
└── Makefile               # 构建和部署脚本
```

---

### 第 3 步：理解核心概念 🧠

#### 3.1 Solana 程序基础
- **程序（Program）**：类似智能合约，运行在 Solana 链上
- **账户（Account）**：存储数据和 SOL 的容器
- **指令（Instruction）**：程序执行的操作
- **PDA（Program Derived Address）**：由程序派生的地址，程序可以为其签名

#### 3.2 Pinocchio 框架特点
- 原生 Rust，不使用 Anchor
- 更小的程序体积
- 更细粒度的控制

#### 3.3 本项目核心逻辑
1. **Deposit（存款）**：
   - 用户调用指令，传入金额
   - 程序验证账户（owner 是签名者，vault 是正确的 PDA）
   - 从 owner 账户转账到 vault PDA

2. **Withdraw（提取）**：
   - 用户调用指令
   - 程序验证账户（owner 是签名者，vault 是正确的 PDA）
   - 使用 PDA 签名，从 vault 转账所有资金到 owner

---

### 第 4 步：从零开始实现（推荐顺序）🚀

#### 阶段 1：搭建基础框架

**4.1 创建项目结构**
```bash
# 创建新的 Rust 库项目
cargo new --lib pinocchio_vault
cd pinocchio_vault

# 编辑 Cargo.toml，添加依赖
```

**4.2 配置 Cargo.toml**
```toml
[package]
name = "pinocchio_vault"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["lib", "cdylib"]

[dependencies]
pinocchio = { version = "0.10.1", features = ["cpi"] }
pinocchio-system = "0.5.0"
solana-address = { version = "2.0.0", features = ["curve25519"] }
solana-program-log = "1.1.0"
```

**4.3 实现 lib.rs（程序入口）**
- 定义程序 ID
- 实现 `process_instruction` 函数
- 根据指令标识符分发到不同指令处理函数

#### 阶段 2：实现 Deposit 指令

**4.4 创建 instructions 模块**
- 创建 `src/instructions/mod.rs`
- 创建 `src/instructions/deposit.rs`

**4.5 实现 Deposit 逻辑**
- 定义 `DepositAccounts` 结构体（账户验证）
- 定义 `DepositInstructionData` 结构体（指令数据解析）
- 实现账户验证逻辑：
  - owner 必须是签名者
  - vault 必须是正确的 PDA（种子：`[b"vault", owner_pubkey]`）
  - vault 初始 lamports 必须为 0
- 实现转账逻辑（使用 `pinocchio_system::instructions::Transfer`）

#### 阶段 3：实现 Withdraw 指令

**4.6 创建 withdraw.rs**
- 定义 `WithdrawAccounts` 结构体
- 实现账户验证逻辑：
  - owner 必须是签名者
  - vault 必须是正确的 PDA
  - vault 必须有余额（lamports > 0）
- 实现提取逻辑：
  - 使用 PDA 签名（seeds: `[b"vault", owner_pubkey, bump]`）
  - 转账所有 lamports 到 owner

#### 阶段 4：IDL 生成和客户端 SDK

**4.7 配置 IDL 生成**
- 在 `Cargo.toml` 中添加 `idl-build` feature
- 在 `instructions/mod.rs` 中使用 `shank` 宏定义指令枚举
- 运行 `shank idl` 生成 IDL 文件

**4.8 配置 Codama 代码生成**
- 创建 `clients/codegen.ts`
- 配置生成 TypeScript 和 Rust 客户端
- 运行生成脚本

---

### 第 5 步：测试和部署 🧪

#### 5.1 编译合约
```bash
# 使用 Makefile
make build

# 或手动编译
cargo build-sbf
```

#### 5.2 生成 IDL
```bash
make idl
# 或
shank idl -o ./idl -r .
```

#### 5.3 生成客户端 SDK
```bash
make sdk
# 或
cd clients && bunx codama run --all
```

#### 5.4 部署到本地网络
```bash
# 确保本地验证节点正在运行
solana-test-validator

# 部署
make deploy
# 或
solana program deploy target/deploy/pinocchio_vault.so
```

#### 5.5 测试合约
```bash
# 使用生成的 Rust 客户端测试
cd clients/src/generated/rust
cargo run --bin blueshift_test

# 或使用 TypeScript 客户端
cd clients
node test_vault.ts
```

---

## 📖 关键代码理解点

### 1. 程序入口（lib.rs）
```rust
fn process_instruction(
    _program_id: &Address,
    accounts: &[AccountView],
    instruction_data: &[u8],
) -> ProgramResult {
    // 根据指令的第一个字节（discriminator）分发
    match instruction_data.split_first() {
        Some((Deposit::DISCRIMINATOR, data)) => 
            Deposit::try_from((data, accounts))?.process(),
        Some((Withdraw::DISCRIMINATOR, _)) => 
            Withdraw::try_from(accounts)?.process(),
        _ => Err(ProgramError::InvalidInstructionData),
    }
}
```

### 2. PDA 派生
```rust
// 派生 PDA 地址
let (vault_key, bump) = Address::find_program_address(
    &[b"vault", owner.address().as_ref()], 
    &crate::ID
);

// 使用 PDA 签名
let seeds = [
    Seed::from(b"vault"),
    Seed::from(owner.address().as_ref()),
    Seed::from(&[bump]),
];
let signers = [Signer::from(&seeds)];
```

### 3. 账户验证模式
每个指令都遵循相同的模式：
1. 从账户数组解析账户（`TryFrom<&[AccountView]>`）
2. 验证账户属性（签名者、所有者、数据等）
3. 验证 PDA 地址是否正确
4. 执行业务逻辑

---

## 🎓 学习建议

### 推荐学习顺序
1. ✅ **先理解 Solana 基础概念**（账户、程序、指令、PDA）
2. ✅ **阅读现有代码**，理解每个文件的作用
3. ✅ **从 lib.rs 开始**，理解程序入口和指令分发
4. ✅ **深入理解 Deposit 指令**，这是最简单的指令
5. ✅ **理解 Withdraw 指令**，学习 PDA 签名
6. ✅ **学习 IDL 生成**，理解如何自动生成客户端
7. ✅ **尝试修改和扩展**，比如添加更多验证或功能

### 实践建议
- 🔹 **先读懂再写**：仔细阅读现有代码，理解每一行的作用
- 🔹 **逐步实现**：不要一次性实现所有功能，先实现最简单的版本
- 🔹 **多测试**：每实现一个功能就测试，确保理解正确
- 🔹 **查阅文档**：Pinocchio、Solana 官方文档是很好的参考

---

## 📚 参考资料

- [Solana 官方文档](https://docs.solana.com/)
- [Pinocchio 文档](https://github.com/coral-xyz/pinocchio)
- [Shank 文档](https://github.com/metaplex-foundation/shank)
- [Codama 文档](https://github.com/coral-xyz/codama)

---

## ❓ 常见问题

### Q: 为什么要使用 Pinocchio 而不是 Anchor？
A: Pinocchio 提供更小的程序体积和更细粒度的控制，适合对性能有要求的场景。

### Q: PDA 是什么？为什么需要它？
A: PDA 是程序派生地址，程序可以为其签名。在这个项目中，每个用户都有一个独立的 vault PDA，程序可以代表用户管理资金。

### Q: 如何调试 Solana 程序？
A: 使用 `solana-program-log` 记录日志，在本地验证节点运行时可以看到日志输出。

---

**祝你学习顺利！** 🚀
