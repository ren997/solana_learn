---
globs: *.rs
description: Rust Solana 程序开发规则
---

# Rust Solana 程序开发规则

## 代码规范

### 导入顺序
1. 标准库
2. 外部依赖（solana、pinocchio 等）
3. 本地模块

### 错误处理
- 使用 `ProgramError` 返回错误
- 提供明确的错误信息
- 使用 `?` 操作符进行错误传播

### 账户解析
- 使用 `TryFrom` trait 实现账户解析
- 验证账户数量：`let [account1, account2, ...] = accounts else { return Err(...) }`
- 验证账户所有者
- 验证签名者权限

### 指令处理
- 使用 discriminator 区分指令
- 使用 `split_first()` 解析指令数据
- 返回 `ProgramResult`

## Pinocchio 特定模式

### 账户结构体
```rust
pub struct InstructionAccounts<'info> {
    pub account1: &'info AccountView,
    pub account2: &'info AccountView,
}

impl<'info> TryFrom<(&'info [u8], &'info [AccountView])> for InstructionAccounts<'info> {
    type Error = ProgramError;
    
    fn try_from((data, accounts): (&'info [u8], &'info [AccountView])) -> Result<Self, Self::Error> {
        // 解析逻辑
    }
}
```

### CPI 调用
- 使用 `pinocchio::cpi` 模块进行跨程序调用
- 验证被调用程序的地址
- 传递正确的账户和指令数据

## 安全注意事项

1. **验证签名者**: 确保关键操作需要签名
2. **验证所有者**: 检查账户的所有者是否正确
3. **验证数据**: 检查账户数据的有效性和完整性
4. **PDA 验证**: 验证 PDA seeds 的正确性
5. **数值溢出**: 使用 checked 数学运算防止溢出
