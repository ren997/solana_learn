---
alwaysApply: true
description: Solana 开发指南和最佳实践
---

# Solana 开发规则

## 项目上下文

这是一个使用 **Pinocchio 框架**开发的 Solana Escrow（托管）程序项目。

- **框架**: Pinocchio 0.10.1
- **项目类型**: Solana 原生程序（非 Anchor）
- **主要功能**: 实现代币托管交换逻辑

## Solana 核心概念

### Accounts（账户）
- Solana 使用账户模型存储数据
- 账户分为：系统账户、程序账户、数据账户
- 账户有 owner（所有者）和 data（数据）字段
- 参考: https://solana.com/docs/core/accounts

### Programs（程序）
- Solana 的智能合约称为"程序"
- 程序是无状态的，数据存储在账户中
- 程序通过 entrypoint 函数接收指令
- 参考: https://solana.com/docs/core/programs

### PDA (Program Derived Address)
- 确定性地址，由程序控制
- 用于创建程序拥有的账户
- Escrow 账户通常使用 PDA
- 参考: https://solana.com/docs/core/pda

### CPI (Cross Program Invocation)
- 程序调用其他程序的方式
- 例如：调用 Token Program 转移代币
- 参考: https://solana.com/docs/core/cpi

### SPL Token
- Solana 的代币标准
- 关键概念：Mint、Token Account、ATA (Associated Token Account)
- 参考: https://solana.com/docs/tokens/basics

## Pinocchio 框架特点

### 账户处理
- 使用 `AccountView` 而不是 Anchor 的 `Account`
- 账户验证需要手动实现
- 使用 `TryFrom` trait 解析账户

### 指令处理
- 使用 discriminator（标识符）区分不同指令
- 通过 `instruction_data.split_first()` 解析指令
- 返回 `ProgramResult`

### 常用类型
- `Address`: 地址类型
- `AccountView`: 账户视图
- `ProgramResult`: 程序执行结果
- `ProgramError`: 程序错误类型

## 开发最佳实践

### 1. 账户验证
- 始终验证账户的所有者（owner）
- 验证签名者（signer）
- 验证账户数据的有效性

### 2. 错误处理
- 使用 `ProgramError` 返回明确的错误
- 提供有意义的错误信息
- 检查边界条件

### 3. 安全性
- 验证所有输入
- 检查账户权限
- 防止重入攻击
- 验证 PDA seeds

### 4. 代码组织
- 将指令分离到独立的模块
- 使用结构体组织账户参数
- 实现清晰的错误处理

## Escrow 特定注意事项

### 账户结构
- `maker`: 创建者账户（必须是签名者）
- `escrow`: 托管账户（通常是 PDA）
- `vault`: 金库账户（存储代币的 ATA）
- `mint_a`, `mint_b`: 两种代币的 Mint 账户
- `maker_ata_a`: 创建者的代币 A 账户

### 关键操作
- 创建 escrow PDA 账户
- 将代币从 maker 转移到 vault
- 验证代币数量和类型
- 实现交换逻辑

## MCP 工具使用

### 什么是 MCP
MCP (Model Context Protocol) 允许 AI 助手访问外部工具和服务，获取实时、准确的 Solana 开发信息。

### 可用的 Solana MCP 工具

1. **Solana Expert: Ask For Help**
   - 用途：询问 Solana 相关问题（如何实现、概念解释、API 使用、错误处理）
   - 使用场景：遇到具体问题时，提供详细上下文后询问
   - 示例：如何创建 PDA、如何处理 CPI 调用、如何验证账户

2. **Solana Documentation Search**
   - 用途：搜索 Solana 官方文档库
   - 使用场景：查找特定功能的文档、API 参考、示例代码
   - 示例：搜索 "PDA creation"、"token transfer"、"account validation"

3. **Ask Solana Anchor Framework Expert**
   - 用途：Anchor 框架相关问题（API、SDK、错误处理）
   - 注意：本项目使用 Pinocchio 框架，但可以参考 Anchor 的实现思路
   - 使用场景：了解 Anchor 如何处理类似问题，作为参考

### 使用建议
- 遇到复杂问题时，优先使用 MCP 工具获取准确答案
- 提供尽可能多的上下文信息（代码、错误信息、目标）
- 结合官方文档和 MCP 工具的回答，获得最佳解决方案

## 参考资源

### 官方文档
- Solana 核心文档: https://solana.com/docs/core/accounts
- Token 基础: https://solana.com/docs/tokens/basics
- 程序开发: https://solana.com/docs/programs
- Cookbook 示例: https://solana.com/developers/cookbook

### LLM 优化文档
- 完整文档: https://solana.com/llms-full.txt
- AI 指南: https://solana.com/SKILL.md

## 代码风格

- 使用 Rust 标准命名约定
- 添加清晰的注释（中文或英文）
- 遵循 SOLID 原则
- 保持代码简洁（KISS）
- 避免过度设计（YAGNI）
