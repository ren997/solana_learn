# 泰铢币（Thai Baht）智能合约操作手册

## 目录

- [项目简介](#项目简介)
- [环境准备](#环境准备)
- [快速开始](#快速开始)
- [详细操作指南](#详细操作指南)
- [常见问题](#常见问题)
- [故障排除](#故障排除)

---

## 项目简介

这是一个 Solana 链上的简单代币合约（泰铢币），用于学习 Solana 程序开发。

### 核心功能

- ✅ **铸造**（Mint）：Ada 可以增发新的泰铢币
- ✅ **转账**（Transfer）：用户之间可以转移泰铢币
- ✅ **查询**（Balance）：查看任意地址的余额
- ✅ **自动开户**：首次转账/铸造时自动创建数据账户

### 技术特点

- 使用 PDA（程序派生地址）存储用户余额
- 余额以大端序 u64 格式存储（8 字节）
- 铸造权限硬编码为 Ada 的地址
- 支持溢出保护（checked_add/checked_sub）

---

## 环境准备

### 1. 系统要求

- 操作系统：Linux / macOS / Windows（WSL2）
- Python 3.8+
- Rust 1.70+
- Solana CLI 1.18+

### 2. 安装 Solana 工具链

```bash
# 安装 Solana CLI
sh -c "$(curl -sSfL https://release.solana.com/stable/install)"

# 添加到 PATH（根据安装提示）
export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"

# 验证安装
solana --version
```

### 3. 安装 Rust 和 Solana 开发工具

```bash
# 安装 Rust
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# 安装 Solana 程序开发工具
cargo install cargo-build-sbf

# 或使用官方工具
solana-install init
```

### 4. 安装 Python 依赖

```bash
# 确保使用 Python 3
python3 --version

# 安装 pxsol 库（Solana Python SDK）
pip3 install pxsol

# 如果系统没有 python 命令，安装别名
sudo apt install python-is-python3 -y  # Ubuntu/Debian
```

### 5. 验证环境

```bash
# 检查所有工具是否安装成功
solana --version        # 应显示版本号
cargo --version         # 应显示版本号
python3 --version       # 应显示版本号
python3 -c "import pxsol"  # 不报错说明 pxsol 已安装
```

---

## 快速开始

### 一、启动本地测试网

**选项 1：使用本地测试网（推荐学习使用）**

```bash
# 在一个单独的终端窗口运行（保持运行状态）
solana-test-validator
```

看到以下输出说明启动成功：
```
Ledger location: test-ledger
✅ JSON RPC URL: http://127.0.0.1:8899
```

**选项 2：使用公共测试网**

```bash
# 配置连接到测试网
solana config set --url https://api.testnet.solana.com

# 领取测试 SOL（每次最多 2 SOL）
solana airdrop 2
```

### 二、配置 Solana CLI

```bash
# 设置网络（如果使用本地测试网）
solana config set --url http://127.0.0.1:8899

# 查看当前配置
solana config get

# 查看余额（本地测试网可以无限领取）
solana balance

# 如果余额为 0，领取测试 SOL
solana airdrop 10
```

### 三、准备部署账户

**重要提示**：默认情况下，`make.py` 使用教程提供的测试账户 Ada 进行部署。这个账户需要有足够的 SOL 来支付部署费用。

#### 选项 1：给 Ada 测试账户转账（推荐用于学习）

```bash
# 1. 从你的默认账户转 10 SOL 给 Ada（足够部署）
solana transfer 6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt 10

# 2. 验证 Ada 收到了 SOL
solana balance 6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt
# 应该显示：10 SOL

# 3. 现在可以部署了（使用默认配置）
# 后续直接运行 python3 make.py deploy
```

**为什么使用 Ada 账户？**
- Ada 是教程中硬编码的"铸造权限所有者"
- 使用 Ada 账户可以正常使用铸造功能
- 教程代码限制只有 Ada 可以铸造新币

#### 选项 2：使用你自己的账户部署

```bash
# 1. 获取你的私钥
# 首先确保你的账户有足够 SOL
solana balance

# 2. 导出你的 Base58 私钥
python3 -c "
import json, pxsol
with open('~/.config/solana/id.json'.replace('~', '$(echo $HOME)'), 'r') as f:
    keypair = json.load(f)
prikey = pxsol.core.PriKey(bytearray(keypair[:32]))
print('你的Base58私钥:', prikey.base58())
print('对应地址:', prikey.pubkey().base58())
"

# 3. 使用你的私钥部署
python3 make.py --prikey <你的Base58私钥> deploy
```

**注意**：使用自己的账户部署后，铸造功能会失败（因为合约限制只有 Ada 能铸造）。

#### 账户信息说明

| 账户 | 地址 | 私钥 | 用途 |
|-----|------|------|------|
| Ada（教程账户） | `6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt` | `11111111111111111111111111111112` | 默认部署账户，有铸造权限 |
| 你的本地账户 | 运行 `solana address` 查看 | 存储在 `~/.config/solana/id.json` | 你的测试账户 |

⚠️ **安全警告**：Ada 的私钥是公开的测试私钥（值为1），**仅用于本地测试网**，切勿在主网使用！

### 四、部署合约

```bash
# 进入项目目录
cd lesson-4-pxsol-thaibaht

# 部署合约（自动编译 + 部署）
python3 make.py deploy

# 成功输出示例：
# main: deploy program
# main: deploy program pubkey="9SP6msRytNxeHXvW38xHxjsBHspqZERDTMh5Wi8xh16Q"
```

> **注意**：程序地址会自动保存到 `res/info.json` 文件中。

### 五、使用合约

#### 1. 铸造代币（仅 Ada 可以）

```bash
# 铸造 1,000,000 个泰铢币
python3 make.py mint 1000000

# 查看 Ada 的余额
python3 make.py balance 6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt
# 输出: 1000000
```

#### 2. 转账

```bash
# Ada 转账 100 个泰铢币给 Bob
python3 make.py transfer 100 8pM1DN3RiT8vbom5u1sNryaNT1nyL8CTTW3b5PwWXRBH

# 查看双方余额
python3 make.py balance 6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt
# 输出: 999900

python3 make.py balance 8pM1DN3RiT8vbom5u1sNryaNT1nyL8CTTW3b5PwWXRBH
# 输出: 100
```

---

## 详细操作指南

### 命令行参数说明

#### 基本语法

```bash
python3 make.py [选项] <命令> [参数...]
```

#### 全局选项

| 选项 | 说明 | 可选值 | 默认值 |
|-----|------|--------|--------|
| `--net` | 选择网络 | develop, testnet, mainnet | develop |
| `--prikey` | 指定私钥 | Base58 编码的私钥 | Ada 的私钥 |

#### 可用命令

| 命令 | 语法 | 说明 | 示例 |
|-----|------|------|------|
| `deploy` | `deploy` | 编译并部署合约 | `python3 make.py deploy` |
| `update` | `update` | 更新已部署的合约 | `python3 make.py update` |
| `mint` | `mint <数量>` | 铸造代币（仅 Ada） | `python3 make.py mint 1000` |
| `transfer` | `transfer <数量> <接收地址>` | 转账代币 | `python3 make.py transfer 50 <地址>` |
| `balance` | `balance <地址>` | 查询余额 | `python3 make.py balance <地址>` |

### 详细操作步骤

#### 1. 部署合约

```bash
# 基本部署（使用默认私钥，部署到本地测试网）
python3 make.py deploy

# 部署到测试网
python3 make.py --net testnet deploy

# 使用自定义私钥部署
python3 make.py --prikey "你的Base58私钥" deploy
```

**内部流程**：
1. 执行 `cargo build-sbf` 编译 Rust 代码
2. 读取 `target/deploy/pxsol_thaibaht.so` 文件
3. 上传到 Solana 网络
4. 将程序地址保存到 `res/info.json`

#### 2. 铸造代币

```bash
# 铸造 1000 个泰铢币
python3 make.py mint 1000

# 铸造 2,100,0000 个泰铢币（类似比特币总量）
python3 make.py mint 21000000
```

**注意事项**：
- ⚠️ 只有 Ada 的地址（`6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt`）可以铸造
- 如果使用其他私钥，会报错：`assertion failed`
- 铸造数量最大为 u64::MAX（18,446,744,073,709,551,615）

**指令数据格式**：
```
[0x00] + [数量的大端序 8 字节]
```

#### 3. 查询余额

```bash
# 查询 Ada 的余额
python3 make.py balance 6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt

# 查询任意地址的余额
python3 make.py balance <任意Solana地址>

# 如果地址从未收到过代币，会报错（数据账户不存在）
```

**原理**：
1. 根据用户地址计算 PDA 数据账户地址
2. 从 RPC 读取 PDA 账户的 8 字节数据
3. 将大端序字节转换为 u64 数字

#### 4. 转账

```bash
# 转账 50 个泰铢币
python3 make.py transfer 50 8pM1DN3RiT8vbom5u1sNryaNT1nyL8CTTW3b5PwWXRBH

# 使用其他账户转账（需要指定私钥）
python3 make.py --prikey "发送者私钥" transfer 100 <接收地址>
```

**注意事项**：
- 发送者必须有足够的泰铢币余额
- 发送者必须有足够的 SOL 支付交易费用
- 如果接收者数据账户不存在，会自动创建（由发送者支付租金）
- 自动进行溢出检查，余额不足会交易失败

**指令数据格式**：
```
[0x01] + [数量的大端序 8 字节]
```

#### 5. 更新合约

```bash
# 修改代码后，更新已部署的合约
python3 make.py update
```

**与 deploy 的区别**：
- `deploy`：创建新的程序账户（新地址）
- `update`：更新现有程序的代码（地址不变）

---

## 常见问题

### Q1: 部署时报错 "AccountNotFound" 或 "Attempt to debit an account"

**错误信息**：
```
Exception: {'code': -32002, 'message': 'Transaction simulation failed: Attempt to debit an account but found no record of a prior credit.', 'data': {'err': 'AccountNotFound', ...}}
```

**原因**：Ada 的测试账户没有足够的 SOL 来支付部署费用。

**解决方案**：
```bash
# 方案 1：给 Ada 转账（推荐）
solana transfer 6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt 10
solana balance 6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt  # 验证
python3 make.py deploy

# 方案 2：使用你自己的账户
# 先获取你的私钥（见"三、准备部署账户"章节）
python3 make.py --prikey <你的Base58私钥> deploy
```

### Q2: 执行 `python make.py` 报错 "Command 'python' not found"

**原因**：系统使用 `python3` 而不是 `python`

**解决方案**：
```bash
# 方案 1：使用 python3
python3 make.py deploy

# 方案 2：安装别名
sudo apt install python-is-python3 -y
```

### Q3: 报错 "No module named 'pxsol'"

**原因**：未安装 pxsol 库

**解决方案**：
```bash
pip3 install pxsol
```

### Q4: 部署时报错 "Connection refused"

**原因**：本地测试网未启动，或 RPC URL 配置错误

**解决方案**：
```bash
# 检查测试网是否运行
curl http://127.0.0.1:8899 -X POST -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1, "method":"getHealth"}'

# 如果失败，启动测试网
solana-test-validator

# 或者使用公共测试网
python3 make.py --net testnet deploy
```

### Q5: 铸造时报错 "assertion failed"

**原因**：你不是 Ada（铸造权限被硬编码）

**解决方案**：
- 方案 1：使用 Ada 的私钥（`--prikey "11111111111111111111111111111112"`）
- 方案 2：修改 `src/lib.rs` 第 35 行，改成你的地址
- 方案 3：移除铸造权限检查（不推荐）

### Q6: 转账时余额不足

**原因**：
1. 泰铢币余额不足
2. SOL 余额不足（无法支付交易费用）

**解决方案**：
```bash
# 查看泰铢币余额
python3 make.py balance <你的地址>

# 查看 SOL 余额
solana balance

# 如果 SOL 不足，领取测试币
solana airdrop 2
```

### Q7: 查询余额时报错 "account not found"

**原因**：该地址的数据账户尚未创建（从未收到过代币）

**解决方案**：
- 这是正常现象
- 发送第一笔转账或铸造时会自动创建账户
- 未创建的账户余额视为 0

### Q8: 编译时报错 "cargo build-sbf not found"

**原因**：未安装 Solana 开发工具

**解决方案**：
```bash
# 确保安装了 Solana 工具链
solana --version

# 如果未安装
sh -c "$(curl -sSfL https://release.solana.com/stable/install)"
```

---

## 故障排除

### 检查清单

执行以下命令检查环境配置：

```bash
# 1. 检查 Solana CLI
solana --version
solana config get

# 2. 检查 Python 环境
python3 --version
python3 -c "import pxsol; print('pxsol 已安装')"

# 3. 检查测试网连接
curl http://127.0.0.1:8899 -X POST -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","id":1, "method":"getHealth"}'

# 4. 检查余额
solana balance

# 5. 检查程序地址是否已保存
cat res/info.json
```

### 完全重置

如果遇到无法解决的问题：

```bash
# 1. 停止本地测试网（Ctrl+C）

# 2. 删除测试网数据
rm -rf test-ledger/

# 3. 重新启动测试网
solana-test-validator

# 4. 重新部署
python3 make.py deploy
```

### 日志查看

```bash
# 查看本地测试网日志
tail -f test-ledger/validator.log

# 查看交易日志（在 make.py 输出中）
# 每次铸造和转账都会打印完整的交易日志
```

---

## 网络配置对比

| 特性 | 本地测试网 (develop) | 公共测试网 (testnet) | 主网 (mainnet) |
|-----|---------------------|---------------------|----------------|
| **RPC URL** | http://127.0.0.1:8899 | https://api.testnet.solana.com | https://api.mainnet-beta.solana.com |
| **需要启动** | ✅ 需要运行 solana-test-validator | ❌ 不需要 | ❌ 不需要 |
| **速度** | 🚀 极快（毫秒级） | 🐌 较慢（秒级） | 🏃 快速 |
| **测试币** | 💰 无限 | 💧 每次最多 2 SOL | 💸 真实代币 |
| **数据持久性** | ❌ 重启清空 | ✅ 永久 | ✅ 永久 |
| **适用场景** | 开发、快速迭代 | 接近真实环境测试 | 生产环境 |

---

## 附录

### 重要地址

| 名称 | 地址 |
|-----|------|
| Ada 的地址 | `6ASf5EcmmEHTgDJ4X4ZT5vT6iHVJBXPg5AN5YoTCpGWt` |
| Bob 的地址 | `8pM1DN3RiT8vbom5u1sNryaNT1nyL8CTTW3b5PwWXRBH` |
| System Program | `11111111111111111111111111111111` |
| Sysvar Rent | `SysvarRent111111111111111111111111111111111` |

### 数据格式说明

#### 指令数据格式

**铸造指令**：
```
字节 0: 0x00 (指令类型)
字节 1-8: 铸造数量（u64 大端序）
```

**转账指令**：
```
字节 0: 0x01 (指令类型)
字节 1-8: 转账数量（u64 大端序）
```

#### PDA 数据账户格式

```
大小: 8 字节
格式: u64 大端序
内容: 用户的泰铢币余额
```

### 相关资源

- Solana 官方文档: https://docs.solana.com/
- pxsol GitHub: https://github.com/mohanson/pxsol
- Solana 开发者教程: https://www.soldev.app/

---

**编写日期**：2026-01-20  
**适用版本**：pxsol-thaibaht v1.0  
**作者**：根据教程整理
